<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Visual Viewport Debugger</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="../../base.css" />

    <style>
        html {
            outline: 10px dashed red;
            outline-offset: -10px;
        }

        body {
            height: 300%;
            position: relative;
        }

        .bar {
            position: absolute;
            top: 0;
            left: calc(50% - 1em);
            bottom: 0;
            width: 2em;
            background: cyan;
            background-image:
                linear-gradient(to bottom, darkmagenta 10px, transparent 1px),
                linear-gradient(to top, slateblue 10px, transparent 1px);
            background-size: 100% calc(100% / 3);
        }

        #debug, #visualviewport {
            position: absolute;
            top: var(--vvpt, 0px);
            left: var(--vvpl, 0px);
            width: var(--vvw, 100%);
            height: var(--vvh, 100%);
            font-size: calc(1em / var(--vvz, 1));
            
            pointer-events: none;
            padding: 1em;
        }

        #visualviewport {
            border: 8px solid;
            border-image: repeating-linear-gradient(
                45deg,
                orange,
                orange 10px,
                transparent 10px,
                transparent 20px
                )
                10;
        }

        #debug div {
            white-space: pre-wrap;
            font-family: monospace;
        }

        main {
            position: absolute;
            right: 10vw;
            top: 10vh;
        }

        input {
            font-size: 16px; /* To prevent auto-zoom on iOS */
        }
    </style>

    <script type="module">
        const clamp = (val, min, max) => Math.min(Math.max(val, min), max);

        const getVisualViewPortValues = ({ clampOffsets = false, resizeDimensions = false }) => {
            let {
                width,
                height,
                widthOrig = null,
                heightOrig = null,
                scale,
                offsetTop,
                offsetLeft,
                pageLeft,
                pageTop,
                pageLeftOrig = null,
                pageTopOrig = null,
            } = window.visualViewport;

            // Adjust values by clamping
            if (clampOffsets) {
                // Cache original values
                pageTopOrig = pageTop;
                pageLeftOrig = pageLeft;
                
                // Adjust values
                pageTop = clamp(pageTop, 0, document.body.offsetHeight - height);
                pageLeft = clamp(pageLeft, 0, document.body.offsetWidth - width);
            }

            // Adjust values by resizing height/width
            if (resizeDimensions) {
                widthOrig = width;
                heightOrig = height;
                pageTopOrig = pageTop;
                pageLeftOrig = pageLeft;

                if (width + pageLeft > document.body.offsetWidth) {
                    width = document.body.offsetWidth - pageLeft;
                }
                if (height + pageTop > document.body.offsetHeight) {
                    height = document.body.offsetHeight - pageTop;
                }
                if (pageLeft < 0) {
                    width += pageLeft;
                    pageLeft = 0;
                }
                if (pageTop < 0) {
                    height += pageTop;
                    pageTop = 0;
                }

            }

            return Object.fromEntries(
                Object.entries({
                    width,
                    widthOrig,
                    height,
                    heightOrig,
                    scale,
                    offsetTop,
                    offsetLeft,
                    pageLeft,
                    pageLeftOrig,
                    pageTop,
                    pageTopOrig,
                })
                .filter(([k, v]) => v !== null)
            );
        };

        const syncVisualViewportValuesToCustomProperties = (vvv, $el = document.documentElement) => {
            $el.style.setProperty('--vvw', `${vvv.width}px`);
            $el.style.setProperty('--vvh', `${vvv.height}px`);
            $el.style.setProperty('--vvpt', `${vvv.pageTop}px`);
            $el.style.setProperty('--vvpl', `${vvv.pageLeft}px`);
            $el.style.setProperty('--vvot', `${vvv.offsetTop}px`);
            $el.style.setProperty('--vvol', `${vvv.offsetLeft}px`);
            $el.style.setProperty('--vvz', vvv.scale);
        }

        const writeVisualViewportValues = (vvv, $el) => {
            $el.innerText = JSON.stringify(vvv, null, 4);
        }

        const getScrollValues = () => {
            let {
                scrollX,
                scrollY,
            } = window;

            return {
                scrollX,
                scrollY,
            };
        }

        const writeScrollValues = (sv, $el) => {
            $el.innerText = JSON.stringify(sv, null, 4);
        }

        const update = (e) => {
            const vvv = getVisualViewPortValues({
                clampOffsets: document.querySelectorAll('#vvAdjustValuesByClamping:checked').length > 0,
                resizeDimensions: document.querySelectorAll('#vvAdjustValuesByResizing:checked').length > 0,
            });
            syncVisualViewportValuesToCustomProperties(vvv);
            writeVisualViewportValues(vvv, document.querySelector("#vv-values"));

            const sv = getScrollValues();
            writeScrollValues(sv, document.querySelector("#s-values"));
        };

        // Show/Hide Options Dialog
        document.querySelector('#btnOptions').addEventListener('click', (e) => {
            e.preventDefault();
            document.querySelector('#options').showModal();
        });
        document.querySelector('#btnOptionsClose').addEventListener('click', (e) => {
            e.preventDefault();
            document.querySelector('#options').close();
        });

        // Update on scroll/resize
        window.addEventListener('scroll', update, { passive: true });
        window.visualViewport.addEventListener('scroll', update, { passive: true });
        window.visualViewport.addEventListener('resize', update, { passive: true });

        // Update after closing the options
        document.querySelector('#options').addEventListener('close', update);

        // Make sure we have values on load
        setTimeout(update, 100);
    </script>
</head>

<body translate="no">
    <div class="bar"></div>
    <main>
        <input type="text" />
    </main>
    <div id="debug">
        <h1>Visual Viewport Debugger</h1>
        <p>Legend:</p>
        <ul>
            <li>Red dashed line = ICB</li>
            <li>Orange slanted line = Visual Viewport <i>(using position absolute)</i></li>
        </ul>
        <p><i>Expected Behavior: Orange lines should always be visible and touch the edges of the visible space. Can lag.</i></p>
        <div id="vv-values"></div>
        <div id="s-values"></div>
        <div id="eventlog"></div>
    </div>
    <div id="visualviewport"></div>

    <button id="btnOptions">options</button>
    <dialog id="options">
        <header>
            <button id="btnOptionsClose">close</button>
            <h1>Options</h1>
        </header>
        <section>
            <h3>Visual Viewport</h3>
            <p>Some browsers allow negative <code>scrollX</code>/<code>scrollY</code>, and allow the same for the Visual Viewport’s <code>pageTop</code>/<code>pageLeft</code>. This may conflict with positioning the Visual Viewport box, so there’s a few fixes one can apply</p>
            <div class="option"><input type="radio" id="vvAdjustValuesNo" name="vvAdjustValues" checked /><label for="vvAdjustValuesNo">Do not adjust values when overscrolling</label></div>
            <div class="option"><input type="radio" id="vvAdjustValuesByClamping" name="vvAdjustValues" /><label for="vvAdjustValuesByClamping">Clamp values between 0 and max scroll when overscrolling</label></div>
            <div class="option"><input type="radio" id="vvAdjustValuesByResizing" name="vvAdjustValues" /><label for="vvAdjustValuesByResizing">Shrink height/width when overscrolling</label></div>
            <h3>Virtual Keyboard</h3>
            <div class="option"><input type="checkbox" id="optVirtualKeyboardOverlaysContent" name="optVirtualKeyboardOverlaysContent" /><label for="optVirtualKeyboardOverlaysContent">Virtual Keyboard Overlays Content</label></div>
        </section>
    </dialog>
</body>
</html>
